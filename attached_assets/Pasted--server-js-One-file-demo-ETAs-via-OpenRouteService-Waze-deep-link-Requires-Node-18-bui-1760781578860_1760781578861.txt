// server.js
// One file demo: ETAs via OpenRouteService + Waze deep link
// Requires: Node 18+ (built in fetch), Express
// Env var: ORS_KEY

const express = require("express");
const app = express();
app.use(express.json());

app.get("/", (_req, res) => {
  res.type("html").send(`<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Free ETA + Waze Link (ORS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 680px }
    label { display:block; margin: 8px 0 4px }
    input { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px }
    button { padding:10px 14px; border:0; border-radius:6px; cursor:pointer }
    .row { display:flex; gap:10px }
    .row > div { flex:1 }
    .card { padding:16px; border:1px solid #eee; border-radius:10px; margin-top:16px }
    .muted { color:#666 }
    .actions { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap }
  </style>
</head>
<body>
  <h1>Free ETA calculator with Waze link</h1>
  <p class="muted">Uses OpenRouteService. Enter coordinates like <code>51.5074,-0.1278</code> or click “Use my location”.</p>

  <div class="row">
    <div>
      <label>Origin lat,lng</label>
      <input id="origin" placeholder="51.5074,-0.1278" />
    </div>
    <div>
      <label>Destination lat,lng</label>
      <input id="dest" placeholder="51.5010,-0.1416" />
    </div>
  </div>

  <div class="actions">
    <button id="geoBtn" type="button">Use my location</button>
    <button id="etaBtn" type="button">Get ETA</button>
  </div>

  <div id="out" class="card" style="display:none;"></div>

  <script>
    const originEl = document.getElementById("origin");
    const destEl = document.getElementById("dest");
    const out = document.getElementById("out");

    document.getElementById("geoBtn").onclick = () => {
      if (!navigator.geolocation) return alert("Geolocation not available");
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        originEl.value = latitude.toFixed(6) + "," + longitude.toFixed(6);
      }, err => alert("Could not get location: " + err.message), { enableHighAccuracy:true, timeout:10000 });
    };

    document.getElementById("etaBtn").onclick = async () => {
      const origin = originEl.value.trim();
      const dest = destEl.value.trim();
      const coordRe = /^[-+]?\\d+\\.\\d+\\s*,\\s*[-+]?\\d+\\.\\d+$/;
      if (!coordRe.test(origin) || !coordRe.test(dest)) {
        return alert("Please enter origin and destination as lat,lng");
      }

      out.style.display = "block";
      out.innerHTML = "Calculating...";

      try {
        const r = await fetch("/api/eta?origin=" + encodeURIComponent(origin) + "&dest=" + encodeURIComponent(dest));
        if (!r.ok) throw new Error("API error " + r.status);
        const data = await r.json();

        const [oLat, oLng] = origin.split(",").map(Number);
        const [dLat, dLng] = dest.split(",").map(Number);

        const wazeURL = "waze://?ll=" + dLat + "," + dLng + "&navigate=yes";
        const wazeWeb = "https://waze.com/ul?ll=" + dLat + "%2C" + dLng + "&navigate=yes";

        out.innerHTML = \`
          <div><strong>ETA:</strong> \${data.etaText} (\${data.durationSeconds}s)</div>
          <div><strong>Distance:</strong> \${data.distanceKm.toFixed(1)} km</div>
          <div class="muted">Source: OpenRouteService (OSM). No live traffic on free tier.</div>
          <div class="actions">
            <a href="\${wazeURL}"><button type="button">Open in Waze</button></a>
            <a href="\${wazeWeb}" target="_blank" rel="noopener"><button type="button">Open Waze on web</button></a>
          </div>
        \`;
      } catch (e) {
        out.innerHTML = "Failed to get ETA: " + e.message;
      }
    };
  </script>
</body>
</html>`);
});

// Free ETA endpoint using OpenRouteService
app.get("/api/eta", async (req, res) => {
  try {
    const apiKey = process.env.ORS_KEY;
    if (!apiKey) return res.status(500).json({ error: "Missing ORS_KEY env var" });

    const origin = (req.query.origin || "").toString();
    const dest = (req.query.dest || "").toString();

    const [oLat, oLng] = origin.split(",").map(Number);
    const [dLat, dLng] = dest.split(",").map(Number);
    if (![oLat, oLng, dLat, dLng].every(Number.isFinite)) {
      return res.status(400).json({ error: "Invalid coordinates. Use lat,lng" });
    }

    // ORS wants start and end as lng,lat
    const url = "https://api.openrouteservice.org/v2/directions/driving-car"
      + `?api_key=${encodeURIComponent(apiKey)}`
      + `&start=${oLng},${oLat}&end=${dLng},${dLat}`;

    const r = await fetch(url);
    if (!r.ok) {
      const text = await r.text();
      return res.status(500).json({ error: "OpenRouteService error", detail: text });
    }
    const json = await r.json();
    const feature = json.features && json.features[0];
    if (!feature) return res.status(404).json({ error: "No route found" });

    const summary = feature.properties && feature.properties.summary || {};
    const seconds = Number(summary.duration) || null;      // seconds
    const distanceMeters = Number(summary.distance) || 0;  // meters

    res.json({
      durationSeconds: seconds,
      etaText: seconds != null ? fmtDuration(seconds) : "n/a",
      distanceKm: distanceMeters / 1000
    });
  } catch (err) {
    res.status(500).json({ error: err.message || "Unknown error" });
  }
});

function fmtDuration(totalSeconds) {
  const h = Math.floor(totalSeconds / 3600);
  const m = Math.floor((totalSeconds % 3600) / 60);
  const s = Math.floor(totalSeconds % 60);
  if (h > 0) return \`\${h}h \${m}m\`;
  if (m > 0) return \`\${m}m \${s}s\`;
  return \`\${s}s\`;
}

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log("Server on http://localhost:" + port);
  console.log("Open the root page to test the ETA and Waze link.");
});